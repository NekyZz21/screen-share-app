<!DOCTYPE html>
<html>
<head>
  <title>Screen Share</title>
  <style>
    body {
      font-family: Arial;
      background: #111;
      color: white;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      border-radius: 5px;
    }
    video {
      width: 45%;
      margin: 10px;
      border-radius: 10px;
      background: black;
    }
  </style>
</head>
<body>

<h1>Screen Share App</h1>

<button id="createRoom">Créer une room</button>
<button id="startShare">Partager mon écran</button>

<p id="roomLink"></p>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const peer = new RTCPeerConnection({
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const roomLink = document.getElementById("roomLink");

let roomId = window.location.pathname.split("/room/")[1];

if (roomId) {
  socket.emit("join-room", roomId);
}

document.getElementById("createRoom").onclick = () => {
  roomId = Math.random().toString(36).substring(2, 9);
  window.location.href = `/room/${roomId}`;
};

peer.ontrack = (event) => {
  remoteVideo.srcObject = event.streams[0];
};

peer.onicecandidate = (event) => {
  if (event.candidate) {
    socket.emit("candidate", event.candidate);
  }
};

socket.on("offer", async (offer) => {
  await peer.setRemoteDescription(offer);
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);
  socket.emit("answer", answer);
});

socket.on("answer", async (answer) => {
  await peer.setRemoteDescription(answer);
});

socket.on("candidate", async (candidate) => {
  await peer.addIceCandidate(candidate);
});

document.getElementById("startShare").onclick = async () => {
  navigator.mediaDevices.getDisplayMedia({ video: true })
    .then(stream => {
      console.log("Partage démarré");
      // ton code WebRTC ici
    })
    .catch(error => {
      console.error("Erreur partage :", error);
    });

const params = new URLSearchParams(window.location.search);
const isHost = params.get("host");

if (isHost === "true") {
  startScreenShare();
}

  localVideo.srcObject = stream;
  stream.getTracks().forEach(track => peer.addTrack(track, stream));

  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);
  socket.emit("offer", offer);
};

if (roomId) {
  roomLink.innerText = "Lien à partager : " + window.location.href;
}
</script>

</body>
</html>